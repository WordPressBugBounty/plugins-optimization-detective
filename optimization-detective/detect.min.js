const win=window,doc=win.document,consoleLogPrefix="[Optimization Detective]",storageLockTimeSessionKey="odStorageLockTime";function isStorageLocked(e,t){if(0===t)return!1;try{const n=parseInt(sessionStorage.getItem("odStorageLockTime"));return!isNaN(n)&&e<n+1e3*t}catch(e){return!1}}function setStorageLock(e){try{sessionStorage.setItem("odStorageLockTime",String(e))}catch(e){}}function log(...e){console.log(consoleLogPrefix,...e)}function warn(...e){console.warn(consoleLogPrefix,...e)}function error(...e){console.error(consoleLogPrefix,...e)}function isViewportNeeded(e,t){let n=!1;for(const{minimumViewportWidth:o,complete:r}of t){if(!(e>=o))break;n=!r}return n}function getCurrentTime(){return Date.now()}function recursiveFreeze(e){for(const t of Object.getOwnPropertyNames(e)){const n=e[t];null!==n&&"object"==typeof n&&recursiveFreeze(n)}Object.freeze(e)}let urlMetric;const reservedRootPropertyKeys=new Set(["url","viewport","elements"]);function getRootData(){const e=structuredClone(urlMetric);return recursiveFreeze(e),e}function extendRootData(e){for(const t of Object.getOwnPropertyNames(e))if(reservedRootPropertyKeys.has(t))throw new Error(`Disallowed setting of key '${t}' on root.`);Object.assign(urlMetric,e)}const elementsByXPath=new Map,reservedElementPropertyKeys=new Set(["isLCP","isLCPCandidate","xpath","intersectionRatio","intersectionRect","boundingClientRect"]);function getElementData(e){const t=elementsByXPath.get(e);if(t){const e=structuredClone(t);return recursiveFreeze(e),e}return null}function extendElementData(e,t){if(!elementsByXPath.has(e))throw new Error(`Unknown element with XPath: ${e}`);for(const e of Object.getOwnPropertyNames(t))if(reservedElementPropertyKeys.has(e))throw new Error(`Disallowed setting of key '${e}' on element.`);const n=elementsByXPath.get(e);Object.assign(n,t)}export default async function detect({minViewportAspectRatio:e,maxViewportAspectRatio:t,isDebug:n,extensionModuleUrls:o,restApiEndpoint:r,currentUrl:i,urlMetricSlug:s,cachePurgePostId:a,urlMetricHMAC:c,urlMetricGroupStatuses:l,storageLockTTL:d,webVitalsLibrarySrc:u,urlMetricGroupCollection:g}){if(n&&log("Stored URL Metric group collection:",g),!isViewportNeeded(win.innerWidth,l))return void(n&&log("No need for URL Metrics from the current viewport."));const f=win.innerWidth/win.innerHeight;if(f<e||f>t)return void(n&&warn(`Viewport aspect ratio (${f}) is not in the accepted range of ${e} to ${t}.`));if(await new Promise((e=>{"loading"!==doc.readyState?e():doc.addEventListener("DOMContentLoaded",e,{once:!0})})),await new Promise((e=>{"complete"===doc.readyState?e():win.addEventListener("load",e,{once:!0})})),"function"==typeof requestIdleCallback&&await new Promise((e=>{requestIdleCallback(e)})),isStorageLocked(getCurrentTime(),d))return void(n&&warn("Aborted detection due to storage being locked."));if(doc.documentElement.scrollTop>0)return void(n&&warn("Aborted detection since initial scroll position of page is not at the top."));n&&log("Proceeding with detection");const w=new Map;for(const e of o)try{const t=await import(e);w.set(e,t),t.initialize instanceof Function&&t.initialize({isDebug:n})}catch(t){error(`Failed to initialize extension '${e}':`,t)}const p=doc.body.querySelectorAll("[data-od-xpath]"),m=new Map([...p].map((e=>[e,e.dataset.odXpath]))),h=[];let y;function P(){y instanceof IntersectionObserver&&(y.disconnect(),win.removeEventListener("scroll",P))}m.size>0&&(await new Promise((e=>{y=new IntersectionObserver((t=>{for(const e of t)h.push(e);e()}),{root:null,threshold:0});for(const e of m.keys())y.observe(e)})),win.addEventListener("scroll",P,{once:!0,passive:!0}));const{onLCP:L}=await import(u),b=[];await new Promise((e=>{L((t=>{b.push(t),e()}),{reportAllChanges:!0})})),P(),n&&log("Detection is stopping."),urlMetric={url:i,viewport:{width:win.innerWidth,height:win.innerHeight},elements:[]};const v=b.at(-1);for(const e of h){const t=m.get(e.target);if(!t){n&&error("Unable to look up XPath for element");continue}const o=v?.entries[0]?.element,r={isLCP:e.target===o,isLCPCandidate:!!b.find((t=>{const n=t.entries[0]?.element;return n===e.target})),xpath:t,intersectionRatio:e.intersectionRatio,intersectionRect:e.intersectionRect,boundingClientRect:e.boundingClientRect};urlMetric.elements.push(r),elementsByXPath.set(r.xpath,r)}if(n&&log("Current URL Metric:",urlMetric),await new Promise((e=>{win.addEventListener("pagehide",e,{once:!0}),win.addEventListener("pageswap",e,{once:!0}),doc.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState&&e()}),{once:!0})})),w.size>0)for(const[e,t]of w.entries())if(t.finalize instanceof Function)try{await t.finalize({isDebug:n,getRootData,getElementData,extendElementData,extendRootData})}catch(t){error(`Unable to finalize module '${e}':`,t)}setStorageLock(getCurrentTime()),n&&log("Sending URL Metric:",urlMetric);const R=new URL(r);R.searchParams.set("slug",s),"number"==typeof a&&R.searchParams.set("cache_purge_post_id",a.toString()),R.searchParams.set("hmac",c),navigator.sendBeacon(R,new Blob([JSON.stringify(urlMetric)],{type:"application/json"})),m.clear()}